version: '3'

tasks:
  tools:
    dir: ./tools
    cmds:
      - docker compose up -d

  build:
    dir: ./scripts
    cmds:
      - npm run build

  run:
    deps:
      - tools
      - build
    cmds:
      - xk6 build --with extension=$(pwd)/extension
      - ./k6 run --summary-trend-stats="avg,min,med,max,p(90),p(95),p(99)" scripts/dist/ledger-simple-write.js
    env:
      POSTGRES_DSN: postgresql://ledger:ledger@postgres:5432/ledger?sslmode=disable
      OTLP_ENDPOINT: otel:4317
      DOCKER_NETWORK: tools_benchmarks

  cleanup:
    dir: ./tools
    cmds:
      - docker compose down -v
