---
version: '3.9'
volumes:
  opensearch_data:
services:
  opensearch:
    image: opensearchproject/opensearch:2.1.0
    environment:
      discovery.type: single-node
      plugins.security.disabled: true
    healthcheck:
      test: curl -s -f -k http://@opensearch:9200/_cat/health >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - opensearch_data:/usr/share/opensearch/data

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.1.0
    environment:
      OPENSEARCH_HOSTS: '["http://opensearch:9200"]' # must be a string with no spaces when specified as an environment variable
      DISABLE_SECURITY_DASHBOARDS_PLUGIN: true
    depends_on:
      opensearch:
        condition: service_healthy
    ports:
      - "5601:5601"

  search-ingester:
    image: "ghcr.io/numary/search-ingester:661ca84c07125202ecbdd57b81bbcc964e1af505"
    depends_on:
      opensearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      KAFKA_ADDRESS: kafka:9092
      KAFKA_TOPIC: ledger,payments
      KAFKA_VERSION: 3.2.0
      KAFKA_CONSUMER_GROUP: search-ingester
      OPENSEARCH_URL: http://opensearch:9200
      OPENSEARCH_INDEX: "formance"
      OPENSEARCH_TLS_ENABLED: "true"
      OPENSEARCH_TLS_SKIP_CERT_VERIFY: "true"
      OPENSEARCH_BASIC_AUTH_ENABLED: "false"

  search:
    image: "ghcr.io/numary/search:661ca84c07125202ecbdd57b81bbcc964e1af505"
    depends_on:
      opensearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      OPEN_SEARCH_SCHEME: http
      OPEN_SEARCH_SERVICE: "opensearch:9200"
      ES_INDICES: "formance"
    labels:
      - traefik.enable=true
      - traefik.http.routers.search.rule=Host(`localhost`) && PathPrefix(`/search`)
      - traefik.http.routers.search.entrypoints=web
      - traefik.http.services.search.loadbalancer.server.port=8080
      - traefik.http.middlewares.search.stripprefix.prefixes=/search
      - traefik.http.routers.search.middlewares=search@docker