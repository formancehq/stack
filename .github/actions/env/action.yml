name: Setup Env
description: Setup Env for Linux x64
inputs:
  os:
    description: Runner OS
    required: true
  token:
    description: Github Token
    required: true

runs:
  using: composite
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - uses: 'actions/setup-node@v3'
    - uses: 'actions/setup-go@v4'
      with:
        go-version: '>=1.20'
    - name: Cache Moon
      id: cache-moon
      uses: actions/cache@v3
      with:
        path: .moon/cache
        key: ${{ inputs.os }}-moon-cache
    - name: Install Task
      uses: arduino/setup-task@v1
      with:
        repo-token: ${{ inputs.token }}
    - run: 'yarn global add @moonrepo/cli'
      shell: bash
    - name: Install GoReleaser
      uses: goreleaser/goreleaser-action@v4
      with:
        distribution: goreleaser-pro
        version: latest
        install-only: true
    - name: Install golangci-lint
      shell: bash
      run: |
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
    - name: Install speakeasy
      shell: bash
      run: |
        wget https://github.com/speakeasy-api/speakeasy/releases/download/v1.36.1/speakeasy_linux_amd64.tar.gz
        tar -zxvf speakeasy_linux_amd64.tar.gz
        chmod +x ./speakeasy
        mv ./speakeasy $(go env GOPATH)/bin/speakeasy
    - name: 'install go deps'
      shell: bash
      run: |
        go install github.com/onsi/ginkgo/v2/ginkgo@v2.8.3
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: "NumaryBot"
        password: ${{ inputs.token }}
