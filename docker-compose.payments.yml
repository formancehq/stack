---
version: '3.9'
volumes:
  mongodb_data:
services:
  mongodb:
    image: mongo:5.0
    command: "mongod --bind_ip_all --replSet replicaSet01 --keyFile /data/replica.key"
    entrypoint:
      - bash
      - -c
      - |
        openssl rand -base64 700 > /data/replica.key
        chmod 400 /data/replica.key
        chown 999:999 /data/replica.key
        exec docker-entrypoint.sh $$@
    healthcheck:
      test: test $$(echo "rs.initiate().ok || rs.status().ok" | mongo -u $${MONGO_INITDB_ROOT_USERNAME} -p $${MONGO_INITDB_ROOT_PASSWORD} --quiet) -eq 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: formance
      MONGO_INITDB_DATABASE: payments
      MONGO_REPLICA_SET_NAME: primary
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017/tcp"
  payments:
    image: "ghcr.io/numary/payments:v0.1.0"
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      MONGODB_URI: "mongodb://admin:formance@mongodb:27017"
      PUBLISHER_KAFKA_ENABLED: true
      PUBLISHER_KAFKA_BROKER: kafka:9092
      PUBLISHER_TOPIC_MAPPING: "*:payments"
    labels:
      - traefik.enable=true
      - traefik.http.routers.payments.rule=Host(`localhost`) && PathPrefix(`/payments`)
      - traefik.http.routers.payments.entrypoints=web
      - traefik.http.services.payments.loadbalancer.server.port=8080
      - traefik.http.middlewares.payments.stripprefix.prefixes=/payments
      - traefik.http.routers.payments.middlewares=payments@docker,cors@docker
