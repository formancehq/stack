---
title: Cluster preparation
---

Before creating our region and deploying the Formance Operator, let's make sure that our cluster is ready to host our operator and have the required following items below in place.

## Ingress controller

The Formance Operator requires an ingress controller to be present on the cluster. The recommended ingress controller is [Traefik](https://doc.traefik.io/traefik/), which is also the one used by Formance Cloud. SSL will need to be enabled, either on the ingress controller itself or on a load balancer in front of it.

:::info
As the Formance Operator will create standard `Ingress` objects to be picked up, alternative ingress controllers can work just as great but might require additional configuration not covered in this setup guide.
:::

## Certificates management

The operator requires [Cert-Manager](https://cert-manager.io/docs/installation/helm/) to run, and to be available on the cluster prior to installing the operator. Make sure to install it now if it's not already set up on your cluster.

:::tip
Default installations of cert-manager should have resources being shown when listed with  
`kubectl get all -n cert-manager`
:::

## Stateful dependencies

In order to function properly, stacks deployed within your private region will need the following stateful dependencies.

<!-- * A PostgreSQL instance
* An Elasticsearch or OpenSearch instance
* A Temporal deployment (optional)

The recommended way to spin up these dependencies is to use your cloud provider's managed services. -->

### NATS

<!-- :::info
::: -->

_Version 2.6 or higher with Jetstream is required._

The recommended way to spin up a NATS deployment is through the official NATS helm [chart](https://artifacthub.io/packages/helm/nats/nats).

:::info
Depending on your setup, you may need to activate Jetsream mode on your NATS deployment manually. Jetstream is required for the resources deployed by the Formance Operator to function properly.
:::

### PostgreSQL

_Version 14 or higher is required._

<!-- :::info
::: -->

The recommended way to spin up a PostgreSQL deployment is to use your cloud provider's managed services. It is recommended to start with a small instance and scale up as needed, starting with for example a `db.m4.large` sizing on AWS.

### Elasticsearch

_Version 7.10 or higher is required._

<!-- :::info
::: -->

The recommended way to spin up an Elasticsearch / OpenSearch deployment is to use your cloud provider's managed service, or Elastic Cloud itself.

:::info
If using Elastic Cloud, make sure to use a deployment in a network with low latency to your cluster.
:::

### Temporal (optional)

:::info
Using Temporal is only required for stacks using the flows service. It can be ommitted now if you don't plan on using it yet, and added at a later time.
:::

The recommended way to spin up a Temporal deployment is through Temporal Cloud, or by using the official Temporal helm [chart](https://github.com/temporalio/helm-charts).

## Custom resource definitions

Two CRDs will be used by the Formance Operator to provision resources in our cluster: the configuration CRD, and the versions CRD.

### Versions CRD

The "Versions" CRD defines the versions that we want to deploy â€” this allows the operator to provision the created stacks with a fixed set of versions for each stack service.

```yaml
# versions.crd.yml
apiVersion: stack.formance.com/v1beta3
kind: Versions
metadata:
    name: default
spec:
    auth: latest
    control: latest
    gateway: latest
    ledger: latest
    orchestration: latest
    payments: latest
    search: latest
    wallets: latest
    webhooks: latest
```

:::tip
Thanks to this CRD, you can also deploy a custom version of a service, including one you've modified yourself.
:::

Saving the CRD is as simple as running the following command:

```bash
kubectl apply -f versions.crd.yml
```

### Configuration CRD

The "Configuration" CRD defines the configuration of our application. This includes configuration settings such as listening ports, environment variables, and secrets.

```yaml
# configuration.crd.yaml
apiVersion: stack.formance.com/v1beta3
kind: Configuration
metadata:
  name: stacks
spec:
  broker:
    nats:
      url: NATS_URL
  ingress:
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: web
  light: true
  services:
    auth:
      postgres:
        disableSSLMode: true
        host: POSTGRESQL_HOST
        port: POSTGRESQL_PORT
        username: POSTGRESQL_USERNAME
        password: POSTGRESQL_PASSWORD
    control: {}
    ledger:
      postgres:
        disableSSLMode: true
        host: POSTGRESQL_HOST
        port: POSTGRESQL_PORT
        username: POSTGRESQL_USERNAME
        password: POSTGRESQL_PASSWORD
    orchestration:
      postgres:
        disableSSLMode: true
        host: POSTGRESQL_HOST
        port: POSTGRESQL_PORT
        username: POSTGRESQL_USERNAME
        password: POSTGRESQL_PASSWORD
    payments:
      encryptionKey: DEFAULT_ENCRYPTION_KEY
      postgres:
        disableSSLMode: true
        host: POSTGRESQL_HOST
        port: POSTGRESQL_PORT
        username: POSTGRESQL_USERNAME
        password: POSTGRESQL_PASSWORD
    search:
      batching:
        count: 50
        period: 1s
      elasticSearch:
        host: ELASTICSEARCH_URL
        pathPrefix: ''
        port: 443
        scheme: https
        tls: {}
    wallets:
      debug: false
      dev: false
    webhooks:
      debug: false
      dev: false
      postgres:
        disableSSLMode: true
        host: POSTGRESQL_HOST
        port: POSTGRESQL_PORT
        username: POSTGRESQL_USERNAME
        password: POSTGRESQL_PASSWORD
  temporal:
    address: TEMPORAL_ADDRESS
    namespace: TEMPORAL_NAMESPACE
    tls:
      crt: TEMPORAL_TLS_CERT
      key: TEMPORAL_TLS_KEY
```

Before saving the CRD, make sure to replace the following values with your own:

-   `NATS_URL`: The URL of your NATS instance
-   `POSTGRESQL_HOST`: The host of your PostgreSQL instance
-   `POSTGRESQL_PORT`: The port of your PostgreSQL instance
-   `POSTGRESQL_USERNAME`: The username of your PostgreSQL instance
-   `POSTGRESQL_PASSWORD`: The password of your PostgreSQL instance
-   `DEFAULT_ENCRYPTION_KEY`: The encryption key to use for the payments service
-   `ELASTICSEARCH_URL`: The URL of your Elasticsearch instance

And the following values if you want to use Temporal:
-   `TEMPORAL_ADDRESS`: The address of your Temporal instance
-   `TEMPORAL_NAMESPACE`: The namespace of your Temporal instance
-   `TEMPORAL_TLS_CERT`: The TLS certificate of your Temporal instance
-   `TEMPORAL_TLS_KEY`: The TLS key of your Temporal instance

Saving the CRD is then simply done by running the following command:

```bash
kubectl apply -f configuration.crd.yml
```

## Summary

Before moving on to the next step, make sure that you have:

- Set up an ingress controller, with SSL enabled
- Installed cert-manager (or had it already installed)
- Deployed the required stateful dependencies
- Created the versions and configuration CRDs

With these steps completed, we can now move on to creating our very own Formance Cloud private region and deploying the Formance Operator.