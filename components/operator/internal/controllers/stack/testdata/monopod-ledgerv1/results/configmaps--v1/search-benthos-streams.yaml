apiVersion: v1
data:
    ledger_ingestion.yaml: "input:\n  event_bus:\n    topic: ledger\n    consumer_group: search\n\npipeline:\n  processors:\n  - switch_event_type:\n      events:\n      - label: COMMITTED_TRANSACTIONS\n        processors:\n        - bloblang: |\n            map account {\n              root = this.map_each(v -> v.value.map_each(v2 -> {\n                \"action\": \"upsert\",\n                \"id\": v.key,\n                \"document\": {\n                  \"data\": {\n                    \"address\": v.key\n                  },\n                  \"indexed\": {\n                    \"address\": v.key\n                  },\n                  \"kind\": \"ACCOUNT\"\n                }\n              }).values()).values().flatten()\n            }\n\n            map tx {\n              root = {\n                \"action\": \"index\",\n                \"id\": \"%s\".format(this.txid),\n                \"document\": {\n                  \"data\": {\n                    \"postings\": this.postings,\n                    \"reference\": this.reference,\n                    \"txid\": this.txid,\n                    \"timestamp\": this.timestamp,\n                    \"metadata\": if this.metadata { this.metadata } else {{}}\n                  },\n                  \"indexed\": {\n                    \"reference\": this.reference,\n                    \"txid\": this.txid,\n                    \"timestamp\": this.timestamp,\n                    \"asset\": this.postings.map_each(p -> p.asset),\n                    \"source\": this.postings.map_each(p -> p.source),\n                    \"destination\": this.postings.map_each(p -> p.destination),\n                    \"amount\": this.postings.map_each(p -> if p.asset.contains(\"/\") {\n                      [\n                        p.amount,\n                        p.amount / if p.asset.split(\"/\").index(1).number(){ range(0, p.asset.split(\"/\").index(1).number()).fold(1, t -> t.tally * 10) } else { 1 } # amount / pow(10, decimal part of asset)\n                      ]\n                    } else { [ p.amount ] }).flatten().map_each(v -> \"%v\".format(v))\n                  },\n                  \"kind\": \"TRANSACTION\"\n                }\n              }\n            }\n\n            map committedTransactions {\n                root = [\n                    this.payload.transactions.map_each(t -> t.apply(\"tx\")).map_each(t -> t.assign({\n                        \"id\": \"TRANSACTION-%s-%s\".format(this.payload.ledger, t.id)\n                    })),\n                    this.payload.transactions.map_each(t -> t.postings.map_each(p -> [{\n                        \"action\": \"upsert\",\n                        \"id\": \"ACCOUNT-%s-%s\".format(this.payload.ledger, p.source),\n                        \"document\": {\n                            \"data\": {\n                                \"address\": p.source,\n                                \"metadata\": {}\n                            },\n                            \"indexed\": {\n                                \"address\": p.source\n                            },\n                            \"kind\": \"ACCOUNT\"\n                        }\n                    }, {\n                        \"action\": \"upsert\",\n                        \"id\": \"ACCOUNT-%s-%s\".format(this.payload.ledger, p.destination),\n                        \"document\": {\n                            \"data\": {\n                                \"address\": p.destination,\n                                \"metadata\": {}\n                            },\n                            \"indexed\": {\n                                \"address\": p.destination\n                            },\n                            \"kind\": \"ACCOUNT\"\n                        }\n                    }])).flatten().flatten()\n                ].flatten().map_each(t -> t.merge({\n                   \"document\": {\n                       \"when\": this.date,\n                       \"ledger\": this.payload.ledger,\n                       \"data\": {\n                           \"ledger\": this.payload.ledger\n                       },\n                       \"indexed\": {\n                           \"ledger\": this.payload.ledger\n                       }\n                   },\n               }))\n            }\n\n            root = this.apply(\"committedTransactions\")\n        - unarchive:\n            format: json_array\n      - label: SAVED_METADATA\n        processors:\n        - bloblang: |\n            root = this.payload.metadata.map_each(item -> {\n              \"script\": \"if (ctx._source.data.metadata == null) { ctx._source.data.metadata = ['\" + item.key + \"': '\" + item.value + \"'] }  ctx._source.data.metadata['\" + item.key + \"']='\" + item.value + \"'\",\n              \"action\": \"update\",\n              \"id\": \"%s-%s-%s\".format(this.payload.targetType, this.payload.ledger, this.payload.targetId),\n              \"upsert\": {\n                \"data\": { \n                  \"address\": this.payload.targetId,\n                  \"metadata\": { item.key: item.value },\n                  \"ledger\": this.payload.ledger\n                },\n                \"indexed\": { \n                  \"address\": this.payload.targetId,\n                  \"ledger\": this.payload.ledger\n                },\n                \"kind\": \"ACCOUNT\",\n                \"when\": this.date\n              }\n            }).values()\n        - unarchive:\n            format: json_array\n\noutput:\n  resource: elasticsearch\n"
    ledger_reindex.yaml: |
        input:
          http_server:
            path: /

        output:
          broker:
            outputs:
            - http_client:
                verb: POST
                url: http://localhost:4195/ledger_reindex_volumes
            - http_client:
                verb: POST
                url: http://localhost:4195/ledger_reindex_transactions
            - http_client:
                verb: POST
                url: http://localhost:4195/ledger_reindex_accounts
    ledger_reindex_accounts.yaml: "input:\n  http_server:\n    path: /\n\npipeline:\n  processors:\n  - bloblang: |\n      meta ledger = this.ledger\n      meta batchSize = 100\n  - postgres_query:\n      service: ledger\n      query: 'select count(*) as accounts_count from \"${! meta(\"ledger\") }\".accounts'\n  - unarchive:\n      format: json_array\n  - bloblang: |\n      meta loopCount = (this.accounts_count.number() / meta(\"batchSize\").number()).ceil()\n      meta loopIndex = 0\n  - bloblang: |\n      root = if meta(\"loopCount\") == \"0\" {\n        deleted() \n      }\n  - while:\n      check: 'meta(\"loopIndex\") < meta(\"loopCount\")'\n      processors:\n      - postgres_query:\n          service: ledger\n          query: |\n            select address, metadata\n            from \"${! meta(\"ledger\") }\".accounts\n            offset ${! meta(\"loopIndex\").number() * meta(\"batchSize\").number() }\n            limit ${! meta(\"batchSize\") }\n      - bloblang:\n          meta loopIndex = meta(\"loopIndex\").number() + 1\n      - unarchive:\n          format: json_array\n      - bloblang: |\n          root = this.assign({\n            \"metadata\": this.metadata.parse_json()\n          })\n      - bloblang: |\n          root = {\n            \"document\": {\n              \"data\": {\n                \"address\": this.address,\n                \"ledger\": meta(\"ledger\"),\n                \"metadata\": this.metadata\n              },\n              \"indexed\": {\n                \"address\": this.address,\n                \"ledger\": meta(\"ledger\")\n              },\n              \"kind\": \"ACCOUNT\",\n              \"ledger\": meta(\"ledger\")\n            },\n            \"id\": \"ACCOUNT-%s-%s\".format(meta(\"ledger\"), this.address),\n            \"action\": \"upsert\"\n          }\n\noutput:\n  resource: elasticsearch\n"
    ledger_reindex_all.yaml: |
        input:
          http_server:
            path: /

        pipeline:
          processors:
          - postgres_query:
              service: ledger
              query: 'select * from "_system".ledgers'
          - unarchive:
              format: json_array

        output:
          broker:
            outputs:
            - http_client:
                verb: POST
                url: http://localhost:4195/ledger_reindex
    ledger_reindex_transactions.yaml: "input:\n  http_server:\n    path: /\n\npipeline:\n  processors:\n  - bloblang: |\n      meta ledger = this.ledger\n      meta batchSize = 100\n  - postgres_query:\n      service: ledger\n      query: 'select count(*) as transactions_count from \"${! meta(\"ledger\") }\".transactions'\n  - unarchive:\n      format: json_array\n  - bloblang: |\n      meta loopCount = (this.transactions_count.number() / meta(\"batchSize\").number()).ceil()\n      meta loopIndex = 0\n  - bloblang: |\n        root = if meta(\"loopCount\") == \"0\" {\n          deleted() \n        }\n  - while:\n      check: 'meta(\"loopIndex\") < meta(\"loopCount\")'\n      processors:\n      - postgres_query:\n          service: ledger\n          query: |\n            select id, timestamp, reference, metadata, postings\n            from \"${! meta(\"ledger\") }\".transactions\n            offset ${! meta(\"loopIndex\").number() * meta(\"batchSize\").number() }\n            limit ${! meta(\"batchSize\") }\n      - bloblang:\n          meta loopIndex = meta(\"loopIndex\").number() + 1\n      - unarchive:\n          format: json_array\n      - bloblang: |\n          root = this.assign({\n            \"postings\": this.postings.parse_json(),\n            \"metadata\": this.metadata.parse_json()\n          })\n      - bloblang: |\n          root = {\n            \"id\": \"TRANSACTION-%s-%s\".format(meta(\"ledger\"), this.id),\n            \"action\": \"upsert\",\n            \"document\": {\n              \"data\": {\n                \"postings\": this.postings,\n                \"reference\": this.reference,\n                \"txid\": this.txid,\n                \"timestamp\": this.timestamp,\n                \"metadata\": if this.metadata { this.metadata } else {{}},\n                \"ledger\": meta(\"ledger\")\n              },\n              \"indexed\": {\n                \"reference\": this.reference,\n                \"txid\": this.id,\n                \"timestamp\": this.timestamp,\n                \"asset\": this.postings.map_each(p -> p.asset),\n                \"source\": this.postings.map_each(p -> p.source),\n                \"destination\": this.postings.map_each(p -> p.destination),\n                \"amount\": this.postings.map_each(p -> if p.asset.contains(\"/\") {\n                  [\n                    p.amount,\n                    p.amount / range(0, p.asset.split(\"/\").index(1).number()).fold(1, t -> t.tally * 10) # amount / pow(10, decimal part of asset)\n                  ]\n                } else { [ p.amount ] }).flatten().map_each(v -> \"%v\".format(v)),\n                \"ledger\": meta(\"ledger\")\n              },\n              \"kind\": \"TRANSACTION\",\n              \"ledger\": meta(\"ledger\"),\n              \"when\": this.date\n            }\n          }\n\noutput:\n  resource: elasticsearch\n"
    ledger_reindex_volumes.yaml: "input:\n  http_server:\n    path: /\n\npipeline:\n  processors:\n  - bloblang: |\n      meta ledger = this.ledger\n      meta batchSize = 100\n  - postgres_query:\n      service: ledger\n      query: 'select count(*) as volumes_count from \"${! meta(\"ledger\") }\".volumes'\n  - unarchive:\n      format: json_array\n  - bloblang: |\n      meta loopCount = (this.volumes_count.number() / meta(\"batchSize\").number()).ceil()\n      meta loopIndex = 0\n  - bloblang: |\n      root = if meta(\"loopCount\") == \"0\" {\n        deleted() \n      }\n  - while:\n      check: 'meta(\"loopIndex\") < meta(\"loopCount\")'\n      processors:\n      - postgres_query:\n          service: ledger\n          query: |\n            select account, asset, input, output\n            from \"${! meta(\"ledger\") }\".volumes\n            offset ${! meta(\"loopIndex\").number() * meta(\"batchSize\").number() }\n            limit ${! meta(\"batchSize\") }\n      - bloblang:\n          meta loopIndex = meta(\"loopIndex\").number() + 1\n      - unarchive:\n          format: json_array\n      - bloblang: |\n          root = {\n            \"id\": \"ASSET-%s-%s-%s\".format(meta(\"ledger\"), this.account, this.asset),\n            \"action\": \"upsert\",\n            \"document\": {\n              \"data\": {\n                \"name\": this.asset,\n                \"input\": this.input,\n                \"output\": this.output,\n                \"account\": this.account,\n                \"ledger\": meta(\"ledger\")\n              },\n              \"indexed\": {\n                \"account\": this.account,\n                \"name\": this.asset,\n                \"ledger\": meta(\"ledger\")\n              },\n              \"kind\": \"ASSET\",\n              \"ledger\": meta(\"ledger\"),\n              \"when\": this.date\n            }\n          }\n\noutput:\n  resource: elasticsearch\n"
    payments_deletion.yaml: "input:\n  event_bus:\n    topic: payments\n    consumer_group: search-payments-resets\n\npipeline:\n  processors:\n  - switch_event_type:\n      events:\n      - label: CONNECTOR_RESET\n        processors:\n        - bloblang: |\n            root = {\n              \"query\": {\n                \"bool\": {\n                  \"must\": [\n                    {\n                      \"bool\": {\n                        \"should\": [\n                          {\n                            \"match\": {\n                              \"kind\": \"PAYMENT\"\n                            }\n                          },\n                          {\n                            \"match\": {\n                              \"kind\": \"PAYMENT_POOL\"\n                            }\n                          },\n                          {\n                            \"match\": {\n                              \"kind\": \"PAYMENT_ACCOUNT\"\n                            }\n                          },\n                          {\n                            \"match\": {\n                              \"kind\": \"PAYMENT_BALANCE\"\n                            }\n                          },\n                          {\n                            \"match\": {\n                              \"kind\": \"PAYMENT_BANK_ACCOUNT\"\n                            }\n                          },\n                          {\n                            \"match\": {\n                              \"kind\": \"PAYMENT_TRANSFER_INITIATION\"\n                            }\n                          }\n                        ]\n                      }\n                    },\n                    {\n                      \"match\": {\n                        \"indexed.connectorId\": this.payload.connectorId\n                      }\n                    },\n                    {\n                      \"match\": {\n                        \"stack\": env(\"STACK\")\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n\n      - label: DELETED_POOL\n        processors:\n        - bloblang: |\n            root = {\n              \"query\": {\n                \"bool\": {\n                  \"must\": [\n                    {\n                      \"match\": {\n                        \"kind\": \"PAYMENT_POOL\"\n                      }\n                    },\n                    {\n                      \"match\": {\n                        \"indexed.id\": this.payload.id\n                      } \n                    },\n                    {\n                      \"match\": {\n                        \"stack\": env(\"STACK\")\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n\n      - label: DELETED_TRANSFER_INITIATION\n        processors:\n        - bloblang: |\n            root = {\n              \"query\": {\n                \"bool\": {\n                  \"must\": [\n                    {\n                      \"match\": {\n                        \"kind\": \"PAYMENT_TRANSFER_INITIATION\"\n                      }\n                    },\n                    {\n                      \"should\": [\n                        {\n                          \"match\": {\n                            \"indexed.id\": this.payload.id\n                          }\n                        },\n                        {\n                          \"match\": {\n                            \"indexed.provider\": this.payload.provider\n                          }\n                        }\n                      ]\n                    },\n                    {\n                      \"match\": {\n                        \"stack\": env(\"STACK\")\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n\noutput:\n  http_client:\n    url: ${OPENSEARCH_URL}/${OPENSEARCH_INDEX}/_delete_by_query\n    verb: POST\n    headers:\n      Content-Type: application/json\n    basic_auth:\n      enabled: ${BASIC_AUTH_ENABLED}\n      username: ${BASIC_AUTH_USERNAME}\n      password: ${BASIC_AUTH_PASSWORD}\n"
    payments_ingestion.yaml: |
        input:
          event_bus:
            topic: payments
            consumer_group: search

        pipeline:
          processors:
          - switch_event_type:
              events:
              - label: SAVED_PAYMENT
                processors:
                - bloblang: |
                      root = {
                          "document": {
                            "data": this.payload,
                            "indexed": {
                                "id": this.payload.id,
                                "reference": this.payload.reference,
                                "provider": this.payload.provider,
                                "createdAt": this.payload.createdAt,
                                "connectorId": this.payload.connectorId,
                                "type": this.payload.type,
                                "status": this.payload.status,
                                "scheme": this.payload.scheme,
                                "asset": this.payload.asset,
                                "initialAmount": this.payload.initialAmount
                            },
                            "kind": "PAYMENT",
                            "when": this.date
                          },
                          "action": "index",
                          "id": "PAYMENT-%s".format(this.payload.id)
                      }
              - label: SAVED_ACCOUNT
                processors:
                - bloblang: |
                      root = {
                        "document": {
                            "data": this.payload,
                            "indexed": {
                                "id": this.payload.id,
                                "provider": this.payload.provider,
                                "createdAt": this.payload.createdAt,
                                "reference": this.payload.reference,
                                "connectorId": this.payload.connectorId,
                                "defaultAsset": this.payload.defaultAsset,
                                "accountName": this.payload.accountName,
                                "type": this.payload.type
                            },
                            "kind": "PAYMENT_ACCOUNT",
                            "when": this.date
                        },
                        "action": "index",
                        "id": "PAYMENT-ACCOUNT-%s".format(this.payload.id)
                      }
              - label: SAVED_BALANCE
                processors:
                - bloblang: |
                      root = {
                          "document": {
                            "data": this.payload,
                            "indexed": {
                                "accountId": this.payload.accountID,
                                "provider": this.payload.provider,
                                "connectorId": this.payload.connectorId,
                                "createdAt": this.payload.createdAt,
                                "asset": this.payload.asset,
                                "balance": this.payload.balance
                            },
                            "kind": "PAYMENT_BALANCE",
                            "when": this.date
                          },
                          "action": "index",
                          "id": "PAYMENT-BALANCE-%s-%s".format(this.payload.accountID, this.payload.asset)
                        }
              - label: SAVED_BANK_ACCOUNT
                processors:
                - bloblang: |
                      root = {
                        "document": {
                            "data": this.payload,
                            "indexed": {
                                "id": this.payload.id,
                                "createdAt": this.payload.createdAt,
                                "connectorId": this.payload.connectorId,
                                "provider": this.payload.provider,
                                "name": this.payload.name,
                                "accountNumber": this.payload.accountNumber,
                                "iban": this.payload.iban,
                                "swiftBicCode": this.payload.swiftBicCode,
                                "country": this.payload.country,
                                "provider": this.payload.provider,
                                "accountId": this.payload.accountID
                            },
                            "kind": "PAYMENT_BANK_ACCOUNT",
                            "when": this.date
                        },
                        "action": "index",
                        "id": "PAYMENT-BANK-ACCOUNT-%s".format(this.payload.id)
                      }
              - label: SAVED_POOL
                processors:
                - bloblang: |
                      root = {
                        "document": {
                            "data": this.payload,
                            "indexed": {
                                "id": this.payload.id,
                                "createdAt": this.payload.createdAt,
                                "name": this.payload.name,
                                "accountIDs": this.payload.accountIDs,
                            },
                            "kind": "PAYMENT_POOL",
                            "when": this.date
                        },
                        "action": "index",
                        "id": "PAYMENT-POOL-%s".format(this.payload.id)
                      }
              - label: SAVED_TRANSFER_INITIATION
                processors:
                - bloblang: |
                      root = {
                       "document": {
                            "data": this.payload,
                            "indexed": {
                                "id": this.payload.id,
                                "createdAt": this.payload.createdAt,
                                "scheduledAt": this.payload.scheduledAt,
                                "updatedAt": this.payload.updatedAt,
                                "connectorId": this.payload.connectorId,
                                "description": this.payload.description,
                                "type": this.payload.type,
                                "provider": this.payload.provider,
                                "sourceAccountId": this.payload.sourceAccountID,
                                "destinationAccountId": this.payload.destinationAccountID,
                                "amount": this.payload.amount,
                                "asset": this.payload.asset,
                                "attempts": this.payload.attempts,
                                "status": this.payload.status,
                                "error": this.payload.error,
                                "relatedPayment": this.payload.relatedPayment
                            },
                            "kind": "PAYMENT_TRANSFER_INITIATION",
                            "when": this.date
                       },
                       "action": "index",
                       "id": "PAYMENT-TRANSFER-INITIATION-%s".format(this.payload.id)
                      }

        output:
          resource: elasticsearch
kind: ConfigMap
metadata:
    labels:
        stack: "true"
    name: search-benthos-streams
    namespace: monopod-ledgerv1
