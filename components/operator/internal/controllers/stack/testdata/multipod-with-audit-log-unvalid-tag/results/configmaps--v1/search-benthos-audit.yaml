apiVersion: v1
data:
    gateway_audit.yaml: |
        input:
          event_bus:
            topic: audit
            consumer_group: search-audit

        pipeline:
          processors:
          - log:
              message: "receive audit message: ${! this.payload.id }"
          - switch_event_type:
              events:
              - label: AUDIT
                processors:
                - bloblang: |
                    root = {
                      "document": {
                        "data": this.payload,
                        "indexed": {
                          "identity": this.payload.identity,
                          "requestPath": this.payload.request.path,
                          "requestMethod": this.payload.request.method,
                          "responseStatusCode": this.payload.response.status_code,
                        },
                        "kind": "AUDIT",
                        "when": this.date
                      },
                      "action": "index",
                      "id": "AUDIT-%s".format(this.payload.id)
                    }


        output:
          resource: elasticsearch
kind: ConfigMap
metadata:
    labels:
        stack: "true"
    name: search-benthos-audit
    namespace: multipod-with-audit-log-unvalid-tag
